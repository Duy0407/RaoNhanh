const hostname=window.location.hostname;if(void 0!=hostname&&""!=hostname){let e=hostname.split(".")[0];class t{constructor(){this.appendTemplate(e),this.tawkChatInputEditor=$("#tawk-chatinput-editor"),this.tawkChatinputAddFile=$("#tawk-chatinput-addFile"),this.listFile=[]}getClientCodeID(){return function(){var e=window.localStorage.getItem("_DEVICEID_");if(e)return e;var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)});return window.localStorage.setItem("_DEVICEID_",t),t}()}appendTemplate(e){let t=`<link rel="stylesheet" href="/css/livechat/app.css?version=1" media="all"><div id="liveChatContainer"><div class="widget ${e}"><button class="talk_button">Tổng đ\xe0i hỗ trợ</button><div class="liveChatMain" style="display: none"><div class="liveChatHeader"><button id="liveChatClose">X</button><div class="text-center text"><a rel="nofollow" download href="/dowload/livechat/ChamCong365.exe" class="text">Bạn tải CHAT365 "tại đ\xe2y" để nhận được sự hỗ trợ tốt nhất, "tải ngay"</a></div></div><div class="liveChatBody"><div class="listConversation"></div><div id="mainEnterChat"><div id="boxPreview" class="hidden"><button class="itemPreview" id="itemAddNewFile"><img src="/images/livechat/add_new_file.svg"></button></div><div id="boxEnterChat"><div contenteditable="true" cvo-placeholder="Nhập nội dung" id="tawk-chatinput-editor"></div><div id="chatinputActionButtons"><button id="btnSendMess" class="hidden"><img src="/images/livechat/btnSendMess.svg"></button><button id="addFile"><img src="/images/livechat/add_file.svg"></button><input type="file" id="tawk-chatinput-addFile" multiple hidden></div></div></div></div><div id="drag"></div></div></div></div>`;$("body").append(t)}changeBody(e){"show"==e?($(".talk_button").hide(),$(".liveChatMain").show(),$(".widget").addClass("active"),$(".listConversation").animate({scrollTop:$(".listConversation").get(0).scrollHeight},0)):($(".talk_button").show(),$(".liveChatMain").hide(),$(".widget").removeClass("active"))}showBtnSendMess(){$("#btnSendMess").removeClass("hidden"),$("#addFile").addClass("hidden")}messByUser(e,t="text",i=[]){let s;return"text"==t&&(s=`<div class="liveChatItem user"><div class="liveChatContent">${e}</div></div>`),"sendPhoto"==t&&(s="",i.forEach(e=>{s+=`<div class="liveChatItem user"><div class="liveChatContent"><img src="https://mess.timviec365.vn/uploads/${void 0!=e.fullName?e.fullName:e.FullName}"></div></div>`})),"sendFile"==t&&(s="",i.forEach(e=>{s+=`<div class="liveChatItem user"><a rel="nofollow" download href="https://mess.timviec365.vn/uploads/${void 0!=e.fullName?e.fullName:e.FullName}"><div class="liveChatContent downloadFile"><div class="downloadFileHeader"><p class="nameFile">${void 0!=e.nameDisplay?e.nameDisplay:e.NameDisplay}</p><p class="sizeFile">${void 0!=e.fileSizeInByte?e.fileSizeInByte:e.FileSizeInByte}</p><p class="typeFile">Tệp</p></div><div class="text-center btnDownLoad">Tải xuống</div></div></a></div>`})),s}messBySwitchboard(e,t=!1,i="text",s=[]){let a=!0==t?'<div class="liveChatLogo"><div class="SwitchboardLogo"><img src="/images/livechat/w_headphone.svg"></div></div>':"",l;return"text"==i&&(l=`<div class="liveChatItem support_switchboard">${a}<div class="liveChatContent"><div class="liveChatContentMess">${e}</div></div></div>`),"sendPhoto"==i&&(l="",s.forEach(e=>{l+=`<div class="liveChatItem support_switchboard">${a}<div class="liveChatContent image"><div class="liveChatContentMess"><img src="https://mess.timviec365.vn/uploads/${void 0!=e.fullName?e.fullName:e.FullName}"></div></div></div>`})),"sendFile"==i&&(l="",s.forEach(e=>{l+=`<div class="liveChatItem support_switchboard">${a}<div class="liveChatContent"><a rel="nofollow" download href="https://mess.timviec365.vn/uploads/${void 0!=e.fullName?e.fullName:e.FullName}"><div class="downloadFile"><div class="downloadFileHeader"><p class="nameFile">${void 0!=e.nameDisplay?e.nameDisplay:e.NameDisplay}</p><p class="sizeFile">${void 0!=e.fileSizeInByte?e.fileSizeInByte:e.FileSizeInByte}</p><p class="typeFile">Tệp</p></div><div class="text-center btnDownLoad">Tải xuống</div></div></a></div></div>`})),l}showPreviewImage(e,t){return`<div class="itemPreview"><button data-index="${t}" class="closePreview" onclick="deleteUploadFile(this)">X</button><img src="${e.result}"></div>`}showPreviewFile(e){return`<div class="itemPreview File"><img src="/images/icon_chat/icon_file.png"><button data-index="${e}" class="closePreview" onclick="deleteUploadFile(this)">X</button></div>`}addMessToList(e,t=""){""==t?$(".listConversation").prepend(e):$(".listConversation").append(e)}message(e,t=!0){if(a.conversationID==e.conversationID)return e.senderID==a.userID?i.messByUser(e.message,e.messageType,e.listFile):i.messBySwitchboard(e.message,t,e.messageType,e.listFile)}previewFile(){$("#boxPreview,#btnSendMess").removeClass("hidden"),$("#addFile").addClass("hidden"),$("div.itemPreview").remove();let e=this.tawkChatinputAddFile.prop("files");for(var t=0;t<e.length;t++){let i=e[t];this.listFile.push(i)}let s=this.listFile.length,a=this,l=["image/gif","image/png","image/jpg","image/jpeg","image/jfif","image/PNG"];for(let n=0;n<s;n++){let o=this.listFile[n],d=o.type;if(o.size,o.name,d==l[0]||d==l[1]||d==l[2]||d==l[3]||d==l[4]||d==l[5]){let r=new FileReader;r.onload=function(e){let t=a.showPreviewImage(r,n);$("#itemAddNewFile").before(t)},r.readAsDataURL(o)}else{let h=a.showPreviewFile(n);$("#itemAddNewFile").before(h)}}this.tawkChatinputAddFile.val("")}reset(){this.tawkChatInputEditor.empty(),$("div.itemPreview").remove(),$("#boxPreview,#btnSendMess").addClass("hidden"),$("#addFile").removeClass("hidden"),this.listFile=[]}}let i=new t;class s{constructor({fromWeb:e,clientSocket:t}){void 0!=e&&("work247"==e||"localhost"==e?this.socket=io.connect("wss://socket.timviec365.vn",{secure:!0,enabledTransports:["https"],transports:["websocket","polling"]}):this.socket=t,this.clientId=i.getClientCodeID(),this.fromWeb=e,this.userID=59721,this.switchboardID=56387,this.listMember=[this.userID,this.switchboardID],this.conversationID,this.apiSentMess="https://mess.timviec365.vn/Message/SendMessage",this.apiUploadFile="https://mess.timviec365.vn/File/UploadFile",this.userLogin(),this.loginWithIdDevice(),this.receiveMess())}callAjax(e,t,i=!1,s="POST"){let a;return $.ajax({type:s,url:e,data:t,async:i,dataType:"json",success:function(e){a=e}}),a}getlistMessages(){let e={clientId:this.clientId,fromWeb:this.fromWeb,countMess:0,countLoad:20};return this.callAjax("https://mess.timviec365.vn/Message/GetListMessage_LiveChat",e)}createConversation(e){let t={senderId:this.userID,contactId:this.switchboardID,clientId:this.clientId,conversationName:"support_"+this.fromWeb+"_"+this.clientId,fromWeb:this.fromWeb},s=this.callAjax("https://mess.timviec365.vn/Conversation/CreateNewLiveChat",t);if(s.data.result){i.tawkChatInputEditor.removeClass("newConversation");let a=s.data.conversation_info.conversationId;this.socket.emit("AddNewConversation",a,this.listMember),this.conversationID=a,this.sendMess(a,e)}}sendMess(e,t){if(i.listFile.length>0){let s=[],a=new FormData,l,n=["image/gif","image/png","image/jpg","image/jpeg","image/jfif","image/PNG"],o;for(let d=0;d<i.listFile.length;d++){let r=i.listFile[d],h=r.name,c=r.size,v=r.type;if(a.append("file",r),v==n[0]||v==n[1]||v==n[2]||v==n[3]||v==n[4]||v==n[5]){var m=new FileReader;o="sendPhoto",m.onload=async function(e){var t=new Image;t.src=e.target.result,t.onload=function(){var e=this.height;l={TypeFile:"sendPhoto",SizeFile:c,Width:this.width,Height:e},s.push(l)}},m.readAsDataURL(r)}else o="sendFile",l={TypeFile:"sendFile",SizeFile:c,NameDisplay:h},s.push(l)}setTimeout(()=>{this.sendFileToChat(a,e,o,s)},1e3)}if(""!=t){let p={ConversationID:e,SenderID:this.userID,MessageType:"text",Message:t};this.callAjax(this.apiSentMess,p,!0)}}sendFileToChat(e,t,i,s){let a=this;$.ajax({url:a.apiUploadFile,type:"POST",contentType:!1,cache:!1,processData:!1,data:e,dataType:"JSON",async:!1,success:function(e){let l=e.data.listNameFile;for(let n=0;n<l.length;n++)s[n].FullName=l[n];let o={ConversationID:t,SenderID:a.userID,MessageType:i,Message:"a",File:JSON.stringify(s)};a.callAjax(a.apiSentMess,o)}})}sendMessToChat(){let e=i.tawkChatInputEditor.text().trim();i.tawkChatInputEditor.hasClass("newConversation")?this.createConversation(e):this.sendMess(a.conversationID,e),i.reset()}receiveMess(){this.socket.on("SendMessage",e=>{let t={senderID:e.SenderID,messageType:e.MessageType,message:e.Message,conversationID:e.ConversationID,listFile:e.ListFile},s=i.message(t);i.addMessToList(s,"append"),$(".listConversation").animate({scrollTop:$(".listConversation").get(0).scrollHeight},0)})}userLogin(){this.socket.emit("Login",this.userID,this.fromWeb)}loginWithIdDevice(){this.socket.emit("LoginWithIdDevice",this.clientId)}loadListMess(e){for(let t=e.length-1;t>=0;t--){let s=e[t];if("notification"!=s.messageType){let a=i.message(s);i.addMessToList(a)}}}init(){let e=this.getlistMessages();if(null==e.data)i.tawkChatInputEditor.addClass("newConversation");else{let t=e.data.listMessages[0].conversationID;this.conversationID=t,this.loadListMess(e.data.listMessages)}}}let a=new s({fromWeb:e,clientSocket:socket});a.init(),$(".talk_button").click(function(){i.changeBody("show")}),$("#liveChatClose").click(function(){i.changeBody("hide")}),$("#addFile,#itemAddNewFile").click(function(){i.tawkChatinputAddFile.click()}),i.tawkChatinputAddFile.change(function(){i.previewFile()}),i.tawkChatInputEditor.keyup(function(e){let t=$(this).text().trim(),s=i.listFile;""!=t||s.length>0?i.showBtnSendMess():i.reset(),13==e.keyCode&&(""!=t||s.length>0)&&a.sendMessToChat()}),$("#btnSendMess").click(function(){a.sendMessToChat()});var l=!1,n=0;function o(e){let t=$(this),s=t.attr("data-index");t.parent().remove(),i.listFile.splice(s,1),i.previewFile(),0==$("div.itemPreview").length&&$("#boxPreview").addClass("hidden")}$(function(){var e=$("#liveChatContainer"),t=$(".liveChatMain");$("#drag").on("mousedown",function(e){l=!0,n=e.clientX}),$(document).on("mousemove",function(i){if(l){console.log(e.offset().left);var s=e.width()-(i.clientX-e.offset().left);t.css("width",s)}}).on("mouseup",function(e){l=!1})})}